@*
 * Copyright 2019 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@this(errorMessage: errorMessage, hint: hint, fieldset: fieldset, input: input)

@(id: Option[String] = None,
  namePrefix: Option[String] = None,
  items: Seq[InputParams] = Nil,
  hintParams: Option[HintParams] = None,
  errorMessageParams: Option[ErrorMessageParams] = None,
  formGroupClasses: String = "",
  fieldsetParams: Option[FieldsetParams] = None,
  classes: String = "",
  attributes: Map[String, String] = Map.empty)
@defining(innerHtmlSnippet) { case (describedBy, innerHtml) =>
  <div class="@toClasses("govuk-form-group", errorMessageParams.fold("")(_ => "govuk-form-group--error"), formGroupClasses)">
    @fieldsetParams.fold(innerHtml) { fieldsetParams =>
      @fieldset(
        describedBy = describedBy.toOption,
        legend = fieldsetParams.legend,
        classes = fieldsetParams.classes,
        attributes = Map("role" -> "group")
        )(innerHtml)
    }
  </div>
}

@dateInputItems = @{
 if (items.nonEmpty) {
   items
 } else {
   Seq(
     InputParams(name = "day", classes = "govuk-input--width-2"),
     InputParams(name = "month", classes = "govuk-input--width-2"),
     InputParams(name = "year", classes = "govuk-input--width-4")
   )
 }
}

@hintSnippet = @{
  hintParams.fold(("", HtmlFormat.empty)) { hintParams =>
    val hintId = id.getOrElse("") + "-hint" //FIXME: https://github.com/alphagov/govuk-frontend/issues/1557
    val describedBy = hintId
    val hintHtml =
      hint(
        id = Some(hintId),
        classes = hintParams.classes,
        attributes = hintParams.attributes)(hintParams.content)
    (describedBy, hintHtml)
  }
}

@errorMessageSnippet(describedBy: String) = @{
  errorMessageParams.fold((describedBy, HtmlFormat.empty)) { errorMessageParams =>
    val errorId = s"${id.getOrElse("")}-error"
    val describedBy1 = if (describedBy.nonEmpty) s"$describedBy $errorId" else errorId
    val errorMessageHtml =
      errorMessage(
        id = Some(errorId),
        classes = errorMessageParams.classes,
        attributes = errorMessageParams.attributes,
        visuallyHiddenText = errorMessageParams.visuallyHiddenText
      )(errorMessageParams.content)
    (describedBy1, errorMessageHtml)
  }
}

@divSnippet = {
  <div class="@toClasses("govuk-date-input", classes)"@toAttributes(attributes)@id.map {id => id="@id"}>
    @for(item <- dateInputItems) {
      <div class="govuk-date-input__item">
        @input(
          id = item.id.getOrElse(id.getOrElse("") + "-" + item.name),
          name = namePrefix.fold(item.name)(_ + "-" + item.name),
          inputType = "number",
          value = item.value,
          labelParams =
            LabelParams(
              classes = "govuk-date-input__label",
              content = item.label.map(Text).getOrElse(Text(item.name.capitalize))
            ),
          classes = toClasses("govuk-date-input__input", item.classes),
          autocomplete = item.autocomplete,
          pattern = Option(item.pattern.getOrElse("[0-9]*".r)),
          attributes = item.attributes
        )
      </div>
    }
  </div>
}

@innerHtmlSnippet = @{
  val (describedBy, hintHtml) = hintSnippet
  val (describedBy1, errorMessageHtml) = errorMessageSnippet(describedBy)
  (describedBy1, HtmlFormat.fill(collection.immutable.Seq(hintHtml, errorMessageHtml, divSnippet)))
}

