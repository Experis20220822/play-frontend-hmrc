@*
 * Copyright 2019 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@this(errorMessage: errorMessage, hint: hint, fieldset: fieldset, input: input)

@(params: DateInputParams)
@import params._
@defining(innerHtmlSnippet) { case (describedBy, innerHtml) =>
  <div class="@toClasses("govuk-form-group", errorMessageParams.fold("")(_ => "govuk-form-group--error"), formGroupClasses)">
    @fieldsetParams.fold(innerHtml) { fieldsetParams =>
      @fieldset(FieldsetParams(
        describedBy = describedBy.toOption,
        legend = fieldsetParams.legend,
        classes = fieldsetParams.classes,
        role = Some("group"),
        attributes = fieldsetParams.attributes,
        html = innerHtml
      ))
    }
  </div>
}

@dateInputItems = @{
 if (items.nonEmpty) {
   items
 } else {
   Seq(
     InputItem(name = "day", classes = "govuk-input--width-2"),
     InputItem(name = "month", classes = "govuk-input--width-2"),
     InputItem(name = "year", classes = "govuk-input--width-4")
   )
 }
}

@hintSnippet(describedBy: String) = @{
  hintParams.fold((describedBy, HtmlFormat.empty)) { hintParams =>
    val hintId = s"${id.getOrElse("")}-hint" //FIXME: https://github.com/alphagov/govuk-frontend/issues/1557
    val describedBy1 = s"$describedBy $hintId".ltrim
    val hintHtml =
      hint(HintParams(
        id = Some(hintId),
        classes = hintParams.classes,
        attributes = hintParams.attributes,
        content = hintParams.content
      ))
    (describedBy1, hintHtml)
  }
}

@errorMessageSnippet(describedBy: String) = @{
  errorMessageParams.fold((describedBy, HtmlFormat.empty)) { errorMessageParams =>
    val errorId = s"${id.getOrElse("")}-error"
    val describedBy1 = s"$describedBy $errorId".ltrim
    val errorMessageHtml =
      errorMessage(ErrorMessageParams(
        id = Some(errorId),
        classes = errorMessageParams.classes,
        attributes = errorMessageParams.attributes,
        visuallyHiddenText = errorMessageParams.visuallyHiddenText,
        content = errorMessageParams.content
      ))
    (describedBy1, errorMessageHtml)
  }
}

@divSnippet = {
  <div class="@toClasses("govuk-date-input", classes)"@toAttributes(attributes)@id.map {id => id="@id"}>
    @for(item <- dateInputItems) {
      <div class="govuk-date-input__item">
        @input(InputParams(
          id = item.id.getOrElse(id.getOrElse("") + "-" + item.name),
          name = namePrefix.fold(item.name)(_ + "-" + item.name),
          inputType = "number",
          value = item.value,
          labelParams =
            LabelParams(
              classes = "govuk-date-input__label",
              content = item.label.map(Text).getOrElse(Text(item.name.capitalize))
            ),
          classes = toClasses("govuk-date-input__input", item.classes),
          autoComplete = item.autoComplete,
          pattern = Option(item.pattern.getOrElse("[0-9]*".r)),
          attributes = item.attributes
        ))
      </div>
    }
  </div>
}

@innerHtmlSnippet = @{
  val describedBy = fieldsetParams.fold("")(fieldsetParams => fieldsetParams.describedBy.getOrElse(""))
  val (describedBy1, hintHtml) = hintSnippet(describedBy)
  val (describedBy2, errorMessageHtml) = errorMessageSnippet(describedBy1)
  (describedBy2, HtmlFormat.fill(collection.immutable.Seq(hintHtml, errorMessageHtml, divSnippet)))
}

